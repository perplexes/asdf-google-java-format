#!/usr/bin/env sh
set -eu

: "${ASDF_INSTALL_TYPE:?}"
: "${ASDF_INSTALL_VERSION:?}"
: "${ASDF_DOWNLOAD_PATH:?}"

owner_repo="google/google-java-format"

# Resolve tag and version
case "$ASDF_INSTALL_TYPE" in
  version)
    ver="${ASDF_INSTALL_VERSION#v}"
    tag="v$ver"
    ;;
  ref)
    # allow raw refs or tags; normalize to start with v if missing
    ref="$ASDF_INSTALL_VERSION"
    case "$ref" in v*) tag="$ref" ;; *) tag="v$ref" ;; esac
    ver="${tag#v}"
    ;;
  *)
    echo "Unknown ASDF_INSTALL_TYPE: $ASDF_INSTALL_TYPE" >&2; exit 1
    ;;
esac

mkdir -p "$ASDF_DOWNLOAD_PATH"

jar="google-java-format-${ver}-all-deps.jar"
jar_url="https://github.com/${owner_repo}/releases/download/${tag}/${jar}"
diff_name="google-java-format-diff.py"
diff_url="https://raw.githubusercontent.com/${owner_repo}/${tag}/scripts/${diff_name}"

echo "Downloading $jar..."
curl -fsSL "$jar_url" -o "${ASDF_DOWNLOAD_PATH}/${jar}"

echo "Downloading ${diff_name}..."
curl -fsSL "$diff_url" -o "${ASDF_DOWNLOAD_PATH}/${diff_name}"
chmod +x "${ASDF_DOWNLOAD_PATH}/${diff_name}"


echo "Downloaded to $ASDF_DOWNLOAD_PATH"
